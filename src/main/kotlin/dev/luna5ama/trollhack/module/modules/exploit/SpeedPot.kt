package dev.luna5ama.trollhack.module.modules.exploit

import dev.fastmc.common.TickTimer
import dev.luna5ama.trollhack.event.SafeClientEvent
import dev.luna5ama.trollhack.event.events.PacketEvent
import dev.luna5ama.trollhack.event.events.player.OnUpdateWalkingPlayerEvent
import dev.luna5ama.trollhack.event.listener
import dev.luna5ama.trollhack.event.safeListener
import dev.luna5ama.trollhack.manager.managers.HotbarSwitchManager
import dev.luna5ama.trollhack.manager.managers.HotbarSwitchManager.ghostSwitch
import dev.luna5ama.trollhack.manager.managers.PlayerPacketManager
import dev.luna5ama.trollhack.manager.managers.PlayerPacketManager.sendPlayerPacket
import dev.luna5ama.trollhack.module.Category
import dev.luna5ama.trollhack.module.Module
import dev.luna5ama.trollhack.util.interfaces.DisplayEnum
import dev.luna5ama.trollhack.util.inventory.hasPotion
import dev.luna5ama.trollhack.util.inventory.slot.allSlots
import dev.luna5ama.trollhack.util.inventory.slot.allSlotsPrioritized
import dev.luna5ama.trollhack.util.inventory.slot.isHotbarSlot
import dev.luna5ama.trollhack.util.math.vector.Vec2f
import dev.luna5ama.trollhack.util.world.getGroundLevel
import net.minecraft.init.Items
import net.minecraft.init.MobEffects
import net.minecraft.inventory.Slot
import net.minecraft.network.play.client.CPacketPlayerTryUseItem
import net.minecraft.potion.Potion
import net.minecraft.util.EnumHand

internal object SpeedPot : Module(
    name = "SpeedPot",
    description = "speed",
    category = Category.EXPLOIT,
    modulePriority = 100
) {
    private val ghostSwitchBypass by setting("Ghost Switch Bypass", HotbarSwitchManager.Override.PICK)
    private val speed by setting("Speed", true)
    private val speedDelay by setting("Speed Delay", 5000, 0..10000, 50, SpeedPot::speed)
    private val hotbarSlot by setting("Hotbar Slot", 1, 1..9, 1) // New slider for hotbar slot

    private var currentPotion = PotionType.NONE

    override fun getHudInfo(): String {
        return currentPotion.displayString
    }

    init {
        onDisable {
            currentPotion = PotionType.NONE
        }

        listener<PacketEvent.PostReceive> {}

        safeListener<OnUpdateWalkingPlayerEvent.Pre> {
            if (!groundCheck()) {
                currentPotion = PotionType.NONE
                return@safeListener
            }

            if (currentPotion == PotionType.NONE) {
                currentPotion = PotionType.VALUES.first {
                    it.check(this)
                }
            }

            if (currentPotion != PotionType.NONE) {
                sendPlayerPacket {
                    rotate(Vec2f(player.rotationYaw, 90.0f))
                }
            }
        }

        safeListener<OnUpdateWalkingPlayerEvent.Post> {
            val potionType = currentPotion
            if (potionType == PotionType.NONE) return@safeListener
            if (PlayerPacketManager.prevRotation.y <= 85.0f || PlayerPacketManager.rotation.y <= 85.0f) return@safeListener

            getSlot(potionType)?.let {
                ghostSwitch(ghostSwitchBypass, it) {
                    connection.sendPacket(CPacketPlayerTryUseItem(EnumHand.MAIN_HAND))
                    potionType.timer.reset()
                    currentPotion = PotionType.NONE
                }
            }
        }
    }

    private fun SafeClientEvent.groundCheck(): Boolean {
        return player.onGround
                || player.posY - world.getGroundLevel(player) < 3.0
    }

    private fun SafeClientEvent.getSlot(potionType: PotionType): Slot? {
        return player.allSlotsPrioritized.findPotion(potionType)
    }

    private fun List<Slot>.findPotion(potionType: PotionType): Slot? {
        return this.asSequence()
            .filter {
                val stack = it.stack
                stack.item == Items.SPLASH_POTION && stack.hasPotion(potionType.potion)
            }.minByOrNull {
                if (it.isHotbarSlot && it.slotIndex == hotbarSlot - 1) -2 // Prioritize the specified hotbar slot
                else if (it.isHotbarSlot) -1 // Then other hotbar slots
                else it.stack.count
            }
    }

    private enum class PotionType(override val displayName: CharSequence, val potion: Potion) : DisplayEnum {
        SPEED("Speed", MobEffects.SPEED) {
            override fun check(event: SafeClientEvent): Boolean {
                return speed
                        && timer.tick(speedDelay)
                        && !event.player.isPotionActive(MobEffects.SPEED)
                        && super.check(event)
            }
        },

        NONE("", MobEffects.LUCK) {
            override fun check(event: SafeClientEvent): Boolean {
                return true
            }
        };

        val timer = TickTimer()

        open fun check(event: SafeClientEvent): Boolean {
            return event.player.allSlots.any { it.stack.hasPotion(this.potion) }
        }

        companion object {
            @JvmField
            val VALUES = values()
        }
    }
}